name: Prepare environment for CI
description: Prepare the environment for CI by preparing and installing common dependencies.

inputs:
  working-directory:
    description: Directory where the action is ran. All other paths are relative to this one. The `go.work` file is expected to be in this directory.
    default: "."
  apt-dependencies:
    description: A space-separated list of apt dependencies to install (Ignored if not using a Linux runner).
    default: ""

runs:
  using: "composite"
  steps:
    - name: setup-go cache workaround #https://github.com/actions/setup-go/issues/424
      shell: bash
      run: echo "TAR_OPTIONS=--skip-old-files" >> $GITHUB_ENV

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: ${{ inputs.working-directory }}/go.work
        cache-dependency-path: |
          ${{ inputs.working-directory }}/insights/go.sum
          ${{ inputs.working-directory }}/server/go.sum
          ${{ inputs.working-directory }}/common/go.sum
          ${{ inputs.working-directory }}/tools/go.sum

    - name: Install dependencies on Linux
      if: runner.os == 'Linux' && inputs.apt-dependencies != ''
      shell: bash
      run: |
        set -e
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ${{ inputs.apt-dependencies }}
